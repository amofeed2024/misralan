<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LEO-AI — صانع الصوت الافتراضي (مزود خارجي: Google / ElevenLabs)</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root { --bg:#0b1437; --card:#0f1a48; --accent:#f97316; --accent-2:#f59e0b; --text:#e6e9f5; --muted:#94a3b8; --danger:#ef4444; --ok:#22c55e; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto;background:radial-gradient(1200px 800px at 80% -10%, #1c2a69 0%, transparent 60%),radial-gradient(900px 700px at -10% 30%, #142053 0%, transparent 60%),var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;font-weight:900;color:#0b0b0b;box-shadow:0 10px 24px rgba(249,115,22,.35)}
    .title{font-size:20px;font-weight:800}
    .muted{color:var(--muted);font-size:12px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px;box-shadow:0 12px 30px rgba(10,15,40,.35)}
    textarea{width:100%;min-height:160px;resize:vertical;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:14px;font-size:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    select,input[type=text],input[type=range]{width:100%;background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px 12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;transition:transform .06s ease, box-shadow .3s ease}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0a0a0a}
    .btn.secondary{background:#1c2a69;color:var(--text)}
    .btn.danger{background:var(--danger);color:white}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#102058;border:1px solid rgba(255,255,255,.08);font-size:12px}

    /* Modal */
    .settings-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:50}
    .settings-content{background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));padding:20px;border-radius:18px;max-width:520px;width:92%;border:1px solid rgba(255,255,255,.1)}
    .settings-content textarea{min-height:80px}

    .list{margin-top:16px;display:grid;gap:10px}
    .item{display:flex;align-items:center;gap:10px;background:#101e56;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
    .item .meta{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0e1a49;border:1px solid rgba(255,255,255,.1);padding:2px 6px;border-radius:8px;font-size:12px}
  </style>
</head>
<body>
  <div id="root" class="container"></div>
  <script type="text/babel">
    const {useState,useEffect,useMemo,useRef} = React;

    // Local storage helpers
    const LS={prov:'leo_prov', key:'leo_api_key', id:'leo_voice_id', specs:'leo_voice_specs'};
    const load=(k,d='')=>{try{const v=localStorage.getItem(k);return v??d}catch{return d}};
    const save=(k,v)=>{try{localStorage.setItem(k,v)}catch{}};

    function App(){
      const[text,setText]=useState("مرحبا! اكتب نصك هنا وسيتم التحويل لصوت عبر المزود الذي تختاره.");
      const[showSettings,setShowSettings]=useState(false);
      const[provider,setProvider]=useState(load(LS.prov,'google')); // 'google' | 'elevenlabs'
      const[apiKey,setApiKey]=useState(load(LS.key,''));
      const[voiceId,setVoiceId]=useState(load(LS.id,'')); // Google: voice name | ElevenLabs: voice_id
      const[voiceSpecs,setVoiceSpecs]=useState(load(LS.specs,'')); // حر لوصف الصوت/اللغة
      const[loading,setLoading]=useState(false);
      const[outputs,setOutputs]=useState([]); // {id, url, provider, createdAt}

      useEffect(()=>save(LS.prov,provider),[provider]);
      useEffect(()=>save(LS.key,apiKey),[apiKey]);
      useEffect(()=>save(LS.id,voiceId),[voiceId]);
      useEffect(()=>save(LS.specs,voiceSpecs),[voiceSpecs]);

      // Helpers
      const b64ToBlob=(b64,mime)=>{const bin=atob(b64);const len=bin.length;const buf=new Uint8Array(len);for(let i=0;i<len;i++)buf[i]=bin.charCodeAt(i);return new Blob([buf],{type:mime})};

      async function ttsGoogle(text){
        // Requires a valid Google Cloud TTS API key with access enabled
        const endpoint=`https://texttospeech.googleapis.com/v1/text:synthesize?key=${encodeURIComponent(apiKey)}`;
        // Try to infer languageCode from specs, fallback to ar-XA
        const lang=(voiceSpecs.match(/lang[:=]\s*([a-zA-Z-]+)/)?.[1])||'ar-XA';
        const body={
          input:{text},
          voice:{languageCode: lang, name: voiceId || undefined},
          audioConfig:{audioEncoding:'MP3',speakingRate:1,pitch:0}
        };
        const res=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!res.ok){throw new Error('Google TTS فشل: '+res.status+' '+(await res.text()))}
        const data=await res.json();
        if(!data.audioContent) throw new Error('لم يتم إرجاع audioContent');
        return b64ToBlob(data.audioContent,'audio/mpeg');
      }

      async function ttsElevenLabs(text){
        const voice = voiceId || 'EXAVITQu4vr4xnSDxMaL'; // افتراضي لو مش متحدد
        const url = `https://api.elevenlabs.io/v1/text-to-speech/${encodeURIComponent(voice)}`;
        const payload = {
          model_id: 'eleven_multilingual_v2',
          text,
          voice_settings: { stability: 0.4, similarity_boost: 0.8 }
        };
        const res=await fetch(url,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'xi-api-key': apiKey
          },
          body: JSON.stringify(payload)
        });
        if(!res.ok){throw new Error('ElevenLabs فشل: '+res.status+' '+(await res.text()))}
        const buf=await res.arrayBuffer();
        return new Blob([buf],{type:'audio/mpeg'});
      }

      async function handleGenerate(){
        if(!apiKey){alert('من فضلك أدخل API Key أولاً');return}
        setLoading(true);
        try{
          let blob;
          if(provider==='google') blob=await ttsGoogle(text);
          else if(provider==='elevenlabs') blob=await ttsElevenLabs(text);
          else throw new Error('مزود غير مدعوم');

          const url=URL.createObjectURL(blob);
          const id=Math.random().toString(36).slice(2);
          setOutputs(prev=>[{id,url,provider,createdAt:new Date().toISOString()},...prev]);
        }catch(err){
          console.error(err); alert(err.message||'حدث خطأ أثناء إنشاء الصوت');
        }finally{ setLoading(false); }
      }

      function removeItem(id){
        setOutputs(prev=>{
          const x=prev.find(o=>o.id===id); if(x) URL.revokeObjectURL(x.url);
          return prev.filter(o=>o.id!==id);
        });
      }

      return (
        <div>
          <header>
            <div className="brand">
              <div className="logo">AI</div>
              <div>
                <div className="title">LEO-AI — صانع الصوت الخارجي</div>
                <div className="muted">العمل عبر مزوّدات حقيقية (Google / ElevenLabs). قد يتطلب تفعيل CORS أو بروكسي على بعض البيئات.</div>
                <div className="muted">المزوّد: <span className="kbd">{provider}</span> · المفتاح: {apiKey? <span className="kbd">••••••</span> : <span className="kbd">غير مُعين</span>} · الصوت: {voiceId? <span className="kbd">{voiceId}</span> : <span className="kbd">غير مُعين</span>}</div>
              </div>
            </div>
            <div style={{display:'flex',gap:10,alignItems:'center'}}>
              <span className="badge">{loading? '⏳ جاري الإنشاء...' : 'جاهز'}</span>
              <button className="btn secondary" onClick={()=>setShowSettings(true)}>إعدادات</button>
            </div>
          </header>

          <div className="card">
            <label>النص</label>
            <textarea value={text} onChange={e=>setText(e.target.value)} placeholder="اكتب النص هنا..." />
            <div className="btns">
              <button className="btn primary" onClick={handleGenerate} disabled={loading}>{loading? 'جاري التحويل...' : 'تحويل إلى صوت'}</button>
            </div>
          </div>

          {/* Outputs */}
          {outputs.length>0 && (
            <div className="card" style={{marginTop:16}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div style={{fontWeight:800}}>الملفات المُولدة</div>
                <div className="muted">عدد: {outputs.length}</div>
              </div>
              <div className="list">
                {outputs.map(item=> (
                  <div key={item.id} className="item">
                    <audio controls src={item.url} style={{flex:1}}></audio>
                    <div className="meta">{item.provider}</div>
                    <a className="btn secondary" href={item.url} download={`tts-${item.provider}-${item.id}.mp3`}>تنزيل</a>
                    <button className="btn danger" onClick={()=>removeItem(item.id)}>حذف</button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {showSettings && (
            <div className="settings-modal" onClick={(e)=>{ if(e.target===e.currentTarget) setShowSettings(false) }}>
              <div className="settings-content">
                <h3>إعدادات</h3>
                <label>مزود الخدمة</label>
                <select value={provider} onChange={e=>setProvider(e.target.value)}>
                  <option value="google">Google Cloud TTS</option>
                  <option value="elevenlabs">ElevenLabs</option>
                </select>
                <label>API Key</label>
                <input type="text" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder={provider==='google'? 'Google API Key' : 'ElevenLabs xi-api-key'} />
                <label>Voice ID / Name</label>
                <input type="text" value={voiceId} onChange={e=>setVoiceId(e.target.value)} placeholder={provider==='google'? 'مثال: ar-XA-Standard-A' : 'مثال: voice_id من ElevenLabs'} />
                <label>مواصفات الصوت (اختياري)</label>
                <textarea value={voiceSpecs} onChange={e=>setVoiceSpecs(e.target.value)} placeholder="lang: ar-XA, pitch: 0, rate: 1 ..." />
                <div className="btns" style={{justifyContent:'flex-end'}}>
                  <button className="btn secondary" onClick={()=>setShowSettings(false)}>إغلاق</button>
                  <button className="btn primary" onClick={()=>setShowSettings(false)}>حفظ الإعدادات</button>
                </div>
                <div className="muted" style={{marginTop:8}}>
                  تنبيه أمني: وضع المفاتيح داخل المتصفح يعرّضها للظهور للمستخدم النهائي. الأفضل استخدام وسيط (Proxy) آمن بالسيرفر عند النشر العام.
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
